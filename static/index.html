<html>
<head>
<title>mortimint</title>
<script src="lodash.min.js"></script>
</head>
<body>
<h1>mortimint</h1>
<div>
  <a href="/progress">progress</a>
  <br/>
  <a href="/emit/">emit</a>
  <br/>
  <a href="/emit/emit.dict">emit.dict</a>
  <br/>
  <a href="/emit/emit.log">emit.log</a>
</div>
<div class="progress">...</div>
<script>
var barTmpl = _.template(
  '<div class="bar">'+
    '<div class="barName"><%= dir %>/<%= fname %></div>'+
    '<div class="barVal" style="min-width: <%= width %>px;"></div>'+
  '</div>');

 function showProgress() {
  fetch('./progress')
    .then(function(response) {
      if (response.status == 200) {
        // Examine the text in the response
        response.json().then(function(data) {
          var pcts = [];
          for (var dir in data.FileSizes) {
            for (var fname in data.FileSizes[dir]) {
              var size = data.FileSizes[dir][fname];
              var curr = _.get(data.FileProgress, [dir, fname], 0);
              pcts.push(barTmpl({dir:   dir,
                                 fname: fname,
                                 width: _.toInteger(500 * (curr/size))}));
            }
          }

          var progressEl = document.getElementsByClassName('progress')[0];
          progressEl.innerHTML = pcts.join("");

          if (data.EmitDone) {
            progressEl.className += " done";
          } else {
            setTimeout(showProgress, 1500);
          }
        });
      }
    })
    .catch(function(err) {
      document.getElementsByClassName('progress')[0].innerText = err;
      console.log('fetch error :-S', err);
    });
}
showProgress();
</script>
<div class="tall">
</div>
<div>
  hi
</div>
<style>
.tall {
  position: relative;
  min-height: 1000px;
}
.bar {
  position: relative;
}
.bar * {
  display: inline-block;
  font-size: 8pt;
}
.bar .barName {
  min-width: 400px;
}
.bar .barVal {
  position: relative;
  min-height: 6px;
  background-color: #8aa;
}
</style>
</body>
</html>
